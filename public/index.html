<!doctype html>
<html lang="fr">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Soumettre un nom</title>
  <style>
    body { font-family: system-ui, sans-serif; margin: 2rem; max-width: 720px; }
    form { display: grid; gap: .75rem; }
    input, textarea { padding: .5rem .75rem; border: 1px solid #e5e7eb; border-radius: 8px; }
    label { font-weight: 600; }
    .row { display: grid; gap: .25rem; }
    .hint { opacity: .7; font-size: .9rem; }
    .ok { color: #065f46; }
    .err { color: #991b1b; }
  </style>
</head>
<body>
  <h1>Soumettre un nom</h1>
  <p>Votre nom pourra être affiché publiquement <a href="/names.html">sur cette page</a> si vous cochez la case prévue.</p>

  <form id="f">
    <div class="row">
      <label for="name">Nom *</label>
      <input id="name" required />
    </div>

    <div class="row">
      <label for="email">Email (optionnel)</label>
      <input id="email" type="email" placeholder="vous@exemple.com" />
    </div>

    <div class="row">
      <label for="payload">Payload JSON *</label>
      <textarea id="payload" rows="5" placeholder='{"message":"Bonjour"}'></textarea>
      <div class="hint">Mettez ici des données libres au format JSON.</div>
    </div>

    <div>
      <label><input type="checkbox" id="consent" required /> J'accepte le stockage de mes données (RGPD).</label>
    </div>
    <div>
      <label><input type="checkbox" id="publicConsent" /> J'accepte que mon <strong>nom</strong> soit affiché publiquement.</label>
    </div>

    <button type="submit">Envoyer</button>
  </form>

  <p id="out"></p>

  <script>
    async function getCsrf() {
      const res = await fetch('/api/submissions/csrf');
      const { csrfToken } = await res.json();
      return csrfToken;
    }

    document.getElementById('f').addEventListener('submit', async (e) => {
      e.preventDefault();
      const out = document.getElementById('out');
      out.textContent = '';

      let payloadObj = {};
      try { payloadObj = JSON.parse(document.getElementById('payload').value || '{}'); }
      catch { out.innerHTML = '<span class="err">Payload invalide (JSON)</span>'; return; }

      const body = {
        name: document.getElementById('name').value,
        email: document.getElementById('email').value || undefined,
        payload: payloadObj,
        consent: document.getElementById('consent').checked,
        publicConsent: document.getElementById('publicConsent').checked
      };

      try {
        const csrf = await getCsrf();
        const res = await fetch('/api/submissions', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json', 'CSRF-Token': csrf },
          body: JSON.stringify(body)
        });
        if (!res.ok) throw new Error('Erreur ' + res.status);
        const data = await res.json();
        out.innerHTML = `<span class="ok">OK ! id = ${data.id}</span>`;
      } catch (err) {
        out.innerHTML = `<span class="err">${err.message}</span>`;
      }
    });
  </script>
</body>
</html>
